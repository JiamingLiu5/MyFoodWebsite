<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>User Management</title>
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
  </head>
  <body>
    <div class="container">
      <header class="page-header">
        <div>
          <h1 class="brand-title">User Management</h1>
          <p class="brand-subtitle">Select a user to view and edit permissions.</p>
        </div>
        <nav class="top-nav">
          <a href="/">Home</a>
          <a href="/tools">Tools</a>
          <a href="/admin/audit">Audit Log</a>
          <form class="top-nav-form" action="/logout" method="post">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
            <button class="top-nav-btn" type="submit">Logout</button>
          </form>
        </nav>
      </header>

      <% if (adminUserError) { %>
        <p class="upload-error"><%= adminUserError %></p>
      <% } %>
      <% if (adminUserMessage) { %>
        <p class="success-note"><%= adminUserMessage %></p>
      <% } %>

      <section class="users-list">
        <% if (users.length === 0) { %>
          <p>No users found.</p>
        <% } else { %>
          <table class="users-table users-directory-table">
            <thead>
              <tr>
                <th>User</th>
                <th>Role</th>
                <th>Pin Right</th>
                <th>Tools</th>
                <th>Last Login</th>
                <th>Manage</th>
              </tr>
            </thead>
            <tbody>
              <% users.forEach(function(user) { %>
                <% const isCurrentUser = Number(user.id) === Number(userId); %>
                <% const hasPinRight = user.role === 'admin' || Number(user.can_pin || 0) === 1; %>
                <% const toolAccess = user.toolAccess || {}; %>
                <% const totalTools = Array.isArray(toolCatalog) ? toolCatalog.length : 0; %>
                <% const enabledTools = user.role === 'admin'
                  ? totalTools
                  : (Array.isArray(toolCatalog)
                    ? toolCatalog.reduce(function(count, tool) { return count + (toolAccess[tool.key] ? 1 : 0); }, 0)
                    : 0);
                %>
                <tr>
                  <td>
                    <div class="users-directory-user">
                      <a class="users-directory-name users-directory-link" href="/admin/users/<%= user.id %>"><%= user.username %></a>
                      <span class="badge">#<%= user.id %></span>
                      <% if (isCurrentUser) { %>
                        <span class="badge">(You)</span>
                      <% } %>
                    </div>
                  </td>
                  <td>
                    <span class="role-badge role-<%= user.role %>"><%= user.role %></span>
                  </td>
                  <td>
                    <span class="permission-badge <%= hasPinRight ? 'permission-on' : 'permission-off' %>">
                      <%= hasPinRight ? 'Can Pin' : 'No Pin' %>
                    </span>
                  </td>
                  <td>
                    <% if (user.role === 'admin') { %>
                      <span class="info-text">All tools enabled</span>
                    <% } else if (!toolCatalog || toolCatalog.length === 0) { %>
                      <span class="info-text">No tools configured</span>
                    <% } else { %>
                      <span class="info-text"><%= enabledTools %> of <%= totalTools %> enabled</span>
                    <% } %>
                  </td>
                  <td>
                    <% if (user.last_login_at) { %>
                      <span title="<%= new Date(user.last_login_at).toISOString() %>"><%= new Date(user.last_login_at).toLocaleString() %></span>
                    <% } else { %>
                      <span class="info-text">Never</span>
                    <% } %>
                  </td>
                  <td>
                    <a class="view-btn user-manage-link" href="/admin/users/<%= user.id %>">Manage</a>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        <% } %>
      </section>

      <div class="info-box">
        <h3>Quick Notes</h3>
        <ul>
          <li>Use <strong>Manage</strong> to open a dedicated page for each user.</li>
          <li>Admins always keep pin and tool access by role.</li>
          <li>You cannot delete yourself or remove the last admin account.</li>
        </ul>
      </div>
    </div>
    <script src="/static/script.js"></script>
  </body>
</html>
