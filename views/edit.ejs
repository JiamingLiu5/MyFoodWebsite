<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Edit Post</title>
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
  </head>
  <body>
    <div class="container">
      <header class="page-header simple">
        <h1 class="brand-title">Edit Post</h1>
      </header>

      <% if (error) { %>
        <p class="upload-error"><%= error %></p>
      <% } %>

      <% if (entry.images && entry.images.length) { %>
        <article class="entry">
          <div class="entry-images <%= entry.images.length > 1 ? 'is-multi' : 'is-single' %>">
            <% entry.images.forEach(function(img) { %>
              <div class="editable-image">
                <a class="entry-image-link" href="<%= fileUrl(img.filename) %>" data-lightbox>
                  <img src="<%= fileUrl(img.filename) %>" alt="Current photo" loading="lazy" decoding="async" />
                </a>
                <label class="remove-image-label">
                  <input type="checkbox" name="removeImageIds" value="<%= img.id %>" form="editPostForm" />
                  Remove this image
                </label>
              </div>
            <% }) %>
          </div>
        </article>
      <% } %>
      <% if (entry.video_filename) { %>
        <article class="entry">
          <div class="entry-video-wrap">
            <video class="entry-video" controls preload="metadata" <% if (entry.video_poster_filename) { %>poster="<%= fileUrl(entry.video_poster_filename) %>"<% } %>>
              <source src="<%= fileUrl(entry.video_filename) %>" <% if (entry.video_mimetype) { %>type="<%= entry.video_mimetype %>"<% } %> />
              Your browser does not support the video tag.
            </video>
            <label class="remove-image-label">
              <input type="checkbox" name="removeVideo" form="editPostForm" />
              Remove current video
            </label>
          </div>
        </article>
      <% } %>

      <form id="editPostForm" action="/entries/<%= entry.id %>/edit" method="post" enctype="multipart/form-data" class="upload-form">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <label>Add photos (optional, up to <%= maxImagesPerPost %> total)</label>
        <input
          type="file"
          name="photos"
          accept="image/*,.heic,.heif,image/heic,image/heif"
          multiple
          data-max-count="<%= maxImagesPerPost %>"
        />
        <label>Add/replace video (optional, 1 file)</label>
        <input
          type="file"
          name="video"
          accept="video/*"
          data-max-size-mb="<%= maxVideoFileSizeMb %>"
        />
        <div class="upload-preview" id="uploadPreview" hidden>
          <img id="uploadPreviewImg" alt="Selected photo preview" />
          <div class="upload-preview-meta">
            <div id="uploadPreviewName"></div>
            <div id="uploadPreviewInfo"></div>
          </div>
        </div>
        <p id="uploadPreviewError" class="upload-preview-error" hidden></p>
        <% if (entry.images && entry.images.length) { %>
          <label><input type="checkbox" name="removeAllPhotos" /> Remove all existing photos</label>
        <% } %>
        <label>Note</label>
        <textarea name="note" rows="4" placeholder="Update your note..."><%= entry.note || '' %></textarea>
        <label>Location</label>
        <input name="location" value="<%= entry.location_text || '' %>" placeholder="e.g. Tokyo Station, Home kitchen, Downtown LA" />
        <label>Tags (comma separated)</label>
        <input name="tags" value="<%= entry.tagText || '' %>" placeholder="spicy, sushi, weekend" />
        <label>Author</label>
        <input name="authorLabel" value="<%= entry.author_label || '' %>" placeholder="e.g. Dad, Mom, Kid A" />
        <label>Collection</label>
        <input list="collectionEditOptions" name="collection" value="<%= entry.collection_name || '' %>" placeholder="e.g. Office Lunches" />
        <datalist id="collectionEditOptions">
          <% (userCollections || []).forEach(function(c) { %>
            <option value="<%= c.name %>"></option>
          <% }) %>
        </datalist>
        <label>
          <input type="checkbox" name="saveAsDraft" value="1" <%= Number(entry.is_draft || 0) === 1 ? 'checked' : '' %> />
          Save as draft
        </label>
        <button type="submit">Save</button>
      </form>

      <p><a href="/entries/<%= entry.id %>">Back</a></p>
    </div>
    <script src="/static/script.js"></script>
  </body>
</html>
