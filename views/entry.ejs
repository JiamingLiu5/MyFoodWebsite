<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Post Detail</title>
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
  </head>
  <body>
    <div class="container">
      <header class="detail-header">
        <h1 class="brand-title">Post Detail</h1>
        <a href="/">Back</a>
      </header>

      <article class="entry detail-entry">
        <% if (entry.video_filename) { %>
          <section class="detail-video-wrap">
            <video id="entryVideo" class="detail-video" controls preload="metadata" <% if (entry.video_poster_filename) { %>poster="<%= fileUrl(entry.video_poster_filename) %>"<% } %>>
              <source src="<%= fileUrl(entry.video_filename) %>" <% if (entry.video_mimetype) { %>type="<%= entry.video_mimetype %>"<% } %> />
              Your browser does not support the video tag.
            </video>
          </section>
        <% } %>
        <% if (entry.images && entry.images.length) { %>
          <section class="detail-gallery">
            <% entry.images.forEach(function(img) { %>
              <a class="detail-image-link" href="<%= fileUrl(img.filename) %>" data-lightbox>
                <img src="<%= fileUrl(img.filename) %>" alt="photo" loading="lazy" decoding="async" />
              </a>
            <% }) %>
          </section>
        <% } else if (!entry.video_filename) { %>
          <p>No images for this post.</p>
        <% } %>

        <div class="meta">
          <% if (entry.isDeleted) { %>
            <div class="pin-badge">Deleted</div>
          <% } else if (Number(entry.is_draft || 0) === 1) { %>
            <div class="pin-badge">Draft</div>
          <% } else if (entry.is_pinned) { %>
            <div class="pin-badge">Pinned</div>
          <% } %>
          <% if (entry.collection_name) { %>
            <div class="author-note">Collection: <strong><%= entry.collection_name %></strong></div>
          <% } %>
          <% if (entry.location_text) { %>
            <div class="author-note">Location: <strong><%= entry.location_text %></strong></div>
          <% } %>
          <% if (entry.rating_value != null) { %>
            <div class="author-note">Rating: <strong><%= Number(entry.rating_value).toFixed(1) %>/10</strong></div>
          <% } %>
          <div class="note"><%= entry.note ? entry.note : '(no note)' %></div>
          <% if (entry.tags && entry.tags.length > 0) { %>
            <div class="tags-row">
              <% entry.tags.forEach(function(tag) { %>
                <a class="tag-chip" href="/?tag=<%= encodeURIComponent(tag) %>">#<%= tag %></a>
              <% }) %>
            </div>
          <% } %>
          <div class="author-note">
            <% const effectiveAuthor = entry.author_label || entry.author_username || ''; %>
            Author:
            <% if (effectiveAuthor) { %>
              <a class="author-link" href="/?author=<%= encodeURIComponent(effectiveAuthor) %>"><strong><%= effectiveAuthor %></strong></a>
            <% } else { %>
              <strong>Unknown user</strong>
            <% } %>
            <% if (entry.author_label && entry.author_username) { %>
              <span>(account: <%= entry.author_username %>)</span>
            <% } %>
          </div>
          <div class="time"><%= new Date(entry.created_at).toLocaleString() %></div>
          <% if (entry.video_filename) { %>
            <p class="detail-hint">Click video controls to play.</p>
          <% } %>
          <% if (entry.images && entry.images.length) { %>
            <p class="detail-hint">Click image to view full size.</p>
          <% } %>

          <div class="entry-actions">
            <% if (entry.isDeleted && canEdit) { %>
              <form class="inline-form" action="/entries/<%= entry.id %>/restore" method="post">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                <input type="hidden" name="returnTo" value="/entries/<%= entry.id %>" />
                <button class="edit-btn" type="submit">Restore</button>
              </form>
            <% } else if (!entry.isDeleted) { %>
              <% if (userCanPin && Number(entry.is_draft || 0) === 0) { %>
                <form class="pin-form" action="/entries/<%= entry.id %>/pin" method="post">
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                  <input type="hidden" name="pinned" value="<%= entry.is_pinned ? 0 : 1 %>" />
                  <input type="hidden" name="returnTo" value="/entries/<%= entry.id %>" />
                  <button class="pin-btn" type="submit"><%= entry.is_pinned ? 'Unpin' : 'Pin' %></button>
                </form>
              <% } %>
              <% if (canEdit) { %>
                <a class="edit-btn" href="/entries/<%= entry.id %>/edit">Edit</a>
                <form class="delete-form" action="/entries/<%= entry.id %>/delete" method="post" onsubmit="return confirm('Move this post to trash?')">
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                  <input type="hidden" name="returnTo" value="/entries/<%= entry.id %>" />
                  <button class="delete-btn" type="submit">Trash</button>
                </form>
              <% } %>
            <% } %>
          </div>
        </div>
      </article>

      <% if (!entry.isDeleted) { %>
        <section class="entry section-card">
          <h3 class="brand-subtitle">Quick Reactions</h3>
          <div class="entry-actions">
            <% (reactionOptions || []).forEach(function(option) { %>
              <form class="inline-form reaction-form" action="/entries/<%= entry.id %>/reactions" method="post" data-reaction="<%= option.value %>" data-reaction-label="<%= option.label %>">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                <input type="hidden" name="reaction" value="<%= option.value %>" />
                <button class="<%= reactions.mine === option.value ? 'pin-btn' : 'view-btn' %>" type="submit">
                  <%= option.label %> (<%= reactions.counts[option.value] || 0 %>)
                </button>
              </form>
            <% }) %>
          </div>
        </section>

        <section class="entry section-card">
          <h3 class="brand-subtitle">Comments (<%= comments.length %>)</h3>
          <% if (userId) { %>
            <form class="upload-form comment-form" action="/entries/<%= entry.id %>/comments" method="post">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
              <label>Add comment</label>
              <textarea name="body" rows="3" maxlength="500" required placeholder="Share your thoughts..."></textarea>
              <button type="submit">Post Comment</button>
            </form>
          <% } else { %>
            <p class="status-note"><a href="/login">Login</a> to comment and react.</p>
          <% } %>

          <% if (comments.length === 0) { %>
            <p class="pinned-only-note">No comments yet.</p>
          <% } else { %>
            <div class="comments-list">
              <% comments.forEach(function(comment) { %>
                <article class="comment-item">
                  <div class="comment-meta">
                    <strong><%= comment.username || 'Unknown user' %></strong>
                    <span><%= new Date(comment.created_at).toLocaleString() %></span>
                  </div>
                  <div class="comment-body"><%= comment.body %></div>
                  <% if (userId && (comment.user_id === userId || userRole === 'admin')) { %>
                    <form class="inline-form" action="/comments/<%= comment.id %>/delete" method="post" onsubmit="return confirm('Delete this comment?')">
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                      <button class="delete-btn" type="submit">Delete Comment</button>
                    </form>
                  <% } %>
                </article>
              <% }) %>
            </div>
          <% } %>
        </section>
      <% } %>
    </div>
    <script src="/static/script.js"></script>
  </body>
</html>
